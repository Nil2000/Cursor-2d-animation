# Use official Bun image as base
FROM oven/bun:1-alpine AS base

# Install system dependencies including FFmpeg and Docker
RUN apk add --no-cache \
    ffmpeg \
    docker-cli

# Install dependencies
FROM base AS install
WORKDIR /app
COPY processor/package.json processor/bun.lock ./
RUN bun install --frozen-lockfile

# Copy node_modules from temp directory
FROM base AS runner
WORKDIR /app
COPY --from=install /app/node_modules ./node_modules

# Copy source code
COPY processor/src/ ./src/
COPY processor/tsconfig.json ./
COPY processor/package.json ./

# Create temp directory for video processing
RUN mkdir -p /app/src/sandbox/temp

# Set environment variables
ENV NODE_ENV=production

# Run the application
CMD ["bun", "run", "start"]